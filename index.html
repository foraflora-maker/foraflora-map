<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Foraflora Bayi Haritası</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css"/>

<style>
body { margin:0; font-family:Arial, sans-serif; }
#map { height: 70vh; }
#panel { padding:10px; }
#list { max-height:200px; overflow:auto; }
.dealer {
  padding:6px;
  border-bottom:1px solid #eee;
  cursor:pointer;
}
.dealer:hover { background:#f5f5f5; }
</style>
</head>

<body>

<div id="panel">
  <select id="citySelect">
    <option value="">Türkiye (Tümü)</option>
  </select>
  <span id="counter"></span>
</div>

<div id="map"></div>
<div id="list"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

<script>
const TYPE_COLORS = {
  uzman: "#f59e0b",
  bayi: "#16a34a",
  satis: "#2563eb"
};

const map = L.map("map").setView([39, 35], 6);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: "© OpenStreetMap"
}).addTo(map);

function createClusterIcon(cluster) {
  const counts = {};
  cluster.getAllChildMarkers().forEach(m => {
    const t = m.options.dealerType;
    counts[t] = (counts[t] || 0) + 1;
  });

  const types = Object.keys(counts);
  const size = 44;

  if (types.length === 1) {
    return L.divIcon({
      html:`<div style="
        background:${TYPE_COLORS[types[0]]};
        width:${size}px;height:${size}px;
        border-radius:50%;
        color:#fff;
        display:flex;
        align-items:center;
        justify-content:center;
        font-weight:bold;">${cluster.getChildCount()}</div>`,
      className:"",
      iconSize:[size,size]
    });
  }

  const gradient = types.map((t,i)=>{
    const a = Math.round(i*(100/types.length));
    const b = Math.round((i+1)*(100/types.length));
    return `${TYPE_COLORS[t]} ${a}% ${b}%`;
  }).join(",");

  return L.divIcon({
    html:`<div style="
      background:conic-gradient(${gradient});
      width:${size}px;height:${size}px;
      border-radius:50%;
      color:#fff;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:bold;">${cluster.getChildCount()}</div>`,
    className:"",
    iconSize:[size,size]
  });
}

const clusters = {
  uzman: L.markerClusterGroup({ iconCreateFunction:createClusterIcon }),
  bayi:  L.markerClusterGroup({ iconCreateFunction:createClusterIcon }),
  satis: L.markerClusterGroup({ iconCreateFunction:createClusterIcon })
};

Object.values(clusters).forEach(c => map.addLayer(c));

const allMarkers = [];
const list = document.getElementById("list");
const citySelect = document.getElementById("citySelect");
const counter = document.getElementById("counter");

fetch("dealers.json")
.then(r=>r.json())
.then(data=>{
  const cities = new Set();

  data.dealers.forEach(d=>{
    cities.add(d.city);

    const marker = L.marker([d.lat,d.lng],{
      dealerType:d.type,
      icon:L.divIcon({
        className:"",
        iconSize:[26,26],
        iconAnchor:[13,26],
        html:`<svg width="26" height="26" viewBox="0 0 24 24" fill="${TYPE_COLORS[d.type]}">
          <path d="M12 2C8 2 5 5 5 9c0 5 7 13 7 13s7-8 7-13c0-4-3-7-7-7z"/>
        </svg>`
      })
    }).bindPopup(`<strong>${d.name}</strong><br>${d.city}`);

    // TÜM MARKER'LARI BAŞTA GÖSTER
allMarkers.forEach(o => {
  clusters[o.data.type].addLayer(o.marker);

  const div = document.createElement("div");
  div.className = "dealer";
  div.innerHTML = `<strong>${o.data.name}</strong><br><small>${o.data.city}</small>`;
  div.onclick = () => {
    map.setView(o.marker.getLatLng(), 14);
    o.marker.openPopup();
  };
  list.appendChild(div);
});

counter.innerText = `Türkiye: ${allMarkers.length}`;


    allMarkers.push({marker,data:d});
  });

  [...cities].sort().forEach(c=>{
    citySelect.innerHTML += `<option value="${c}">${c}</option>`;
  });
});

function applyFilter(city){
  Object.values(clusters).forEach(c=>c.clearLayers());
  list.innerHTML = "";

  const visible = allMarkers.filter(o=>!city || o.data.city===city);

  visible.forEach(o=>{
    clusters[o.data.type].addLayer(o.marker);

    const div = document.createElement("div");
    div.className = "dealer";
    div.innerHTML = `<strong>${o.data.name}</strong><br><small>${o.data.city}</small>`;
    div.onclick = ()=>{
      map.setView(o.marker.getLatLng(),14);
      o.marker.openPopup();
    };
    list.appendChild(div);
  });

  counter.innerText = city
    ? `${city}: ${visible.length}`
    : `Türkiye: ${visible.length}`;

  if (visible.length){
    const g = L.featureGroup(visible.map(o=>o.marker));
    map.fitBounds(g.getBounds().pad(0.3));
  }
}

citySelect.onchange = ()=>applyFilter(citySelect.value);
</script>

</body>
</html>

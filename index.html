<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Foraflora Bayiler</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="robots" content="noindex,nofollow">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">

<style>
body { margin:0; font-family:Arial,sans-serif; }
#app { display:flex; height:100vh; }
#sidebar {
  width:320px;
  padding:12px;
  overflow:auto;
  border-right:1px solid #eee;
}
#map { flex:1; }
h3 { margin-top:0; }
select { width:100%; padding:6px; margin-bottom:8px; }
.counter {
  background:#f3f3f3;
  padding:8px;
  border-radius:6px;
  margin-bottom:8px;
  font-weight:bold;
}
.layer { margin-bottom:6px; }
.dealer {
  padding:6px;
  border-bottom:1px solid #eee;
  cursor:pointer;
}
.dealer:hover { background:#f8f8f8; }
.dealer small { color:#666; }
</style>
</head>

<body>
<div id="app">
  <div id="sidebar">
    <h3>Bayiler</h3>

    <select id="cityFilter">
      <option value="">Tüm Türkiye</option>
    </select>

    <div id="counter" class="counter"></div>
    <div id="layers"></div>
    <div id="list"></div>
  </div>

  <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
const map = L.map("map").setView([39,35],6);

L.tileLayer(
  "https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",
  { attribution:"© OpenStreetMap © CARTO" }
).addTo(map);

fetch("dealers.json").then(r=>r.json()).then(data=>{
  const clusters={}, markers=[];
  const citySelect=document.getElementById("cityFilter");
  const counter=document.getElementById("counter");
  const list=document.getElementById("list");
  const layersDiv=document.getElementById("layers");

  // Şehir dropdown
  [...new Set(data.dealers.map(d=>d.city))].sort().forEach(c=>{
    citySelect.innerHTML+=`<option value="${c}">${c}</option>`;
  });

  // Katmanlar
  for(const k in data.layers){
    clusters[k]=L.markerClusterGroup();
    if(data.layers[k].visible) map.addLayer(clusters[k]);

    layersDiv.innerHTML+=`
      <div class="layer">
        <label>
          <input type="checkbox" checked data-layer="${k}">
          ${data.layers[k].label}
        </label>
      </div>`;
  }

  layersDiv.querySelectorAll("input").forEach(cb=>{
    cb.onchange=e=>{
      const k=e.target.dataset.layer;
      e.target.checked ? map.addLayer(clusters[k]) : map.removeLayer(clusters[k]);
    };
  });

  // Markerlar
  data.dealers.forEach(d=>{
    const icon=L.divIcon({
      html:`<svg width="28" height="28" viewBox="0 0 24 24" fill="${data.layers[d.type].color}">
        <path d="M12 2C8 2 5 5 5 9c0 5 7 13 7 13s7-8 7-13c0-4-3-7-7-7z"/>
      </svg>`,
      className:"",
      iconSize:[28,28],
      iconAnchor:[14,28]
    });

    const m=L.marker([d.lat,d.lng],{icon})
      .bindPopup(`
        <strong>${d.name}</strong><br>
        ${d.address}<br>
        <a target="_blank"
        href="https://www.google.com/maps/dir/?api=1&destination=${d.lat},${d.lng}">
        Yol tarifi al</a>
      `);

    clusters[d.type].addLayer(m);
    markers.push({m,d});

    const div=document.createElement("div");
    div.className="dealer";
    div.innerHTML=`<strong>${d.name}</strong><br><small>${d.city}</small>`;
    div.onclick=()=>{ map.setView([d.lat,d.lng],14); m.openPopup(); };
    list.appendChild(div);
  });

  function applyFilter(){
    const city=citySelect.value;
    let count=0;
    markers.forEach(o=>{
      const show=!city || o.d.city===city;
      show ? clusters[o.d.type].addLayer(o.m) : clusters[o.d.type].removeLayer(o.m);
      if(show) count++;
    });

    counter.innerText = city ? `${city}: ${count}` : `Türkiye: ${count}`;

    if(city){
      const g=L.featureGroup(markers.filter(o=>o.d.city===city).map(o=>o.m));
      if(g.getLayers().length) map.fitBounds(g.getBounds().pad(0.3));
    } else map.setView([39,35],6);
  }

  citySelect.onchange=applyFilter;
  applyFilter();
});
</script>
</body>
</html>

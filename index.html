<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<title>Foraflora Bayiler</title>
<meta name="robots" content="noindex,nofollow">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>

<style>
body { margin:0; font-family:Arial,sans-serif; }
#container { display:flex; height:100vh; }
#sidebar {
  width:320px; padding:12px;
  border-right:1px solid #eee;
  overflow-y:auto;
}
#map { flex:1; }
.counter {
  background:#f5f5f5;
  padding:8px;
  margin:10px 0;
  border-radius:6px;
  font-weight:bold;
}
select {
  width:100%;
  padding:6px;
  margin-bottom:8px;
}
.layer-toggle { margin-bottom:6px; }
.dealer {
  cursor:pointer;
  padding:6px 4px;
  border-bottom:1px solid #f0f0f0;
}
.dealer:hover { background:#f7f7f7; }
.dealer small { color:#666; }
</style>
</head>

<body>
<div id="container">
  <div id="sidebar">
    <h3>Bayiler</h3>

    <!-- ŞEHİR DROPDOWN -->
    <select id="cityFilter">
      <option value="">Tüm Türkiye</option>
    </select>

    <div id="counter" class="counter">Türkiye: 0</div>
    <div id="layerToggles"></div>
    <div id="dealerList"></div>
  </div>
  <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
const map = L.map("map", { zoomSnap: 0.5 }).setView([39,35], 6);

L.tileLayer(
  "https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",
  { attribution:"© OpenStreetMap © CARTO" }
).addTo(map);

fetch("dealers.json")
.then(r=>r.json())
.then(data=>{
  const clusters = {};
  const dealerList = document.getElementById("dealerList");
  const toggles = document.getElementById("layerToggles");
  const counter = document.getElementById("counter");
  const citySelect = document.getElementById("cityFilter");

  // Şehir listesi
  const cities = [...new Set(data.dealers.map(d=>d.city))].sort();
  cities.forEach(c=>{
    const opt=document.createElement("option");
    opt.value=c;
    opt.textContent=c;
    citySelect.appendChild(opt);
  });

  // Katmanlar
  for(const key in data.layers){
    clusters[key] = L.markerClusterGroup({
      showCoverageOnHover:false
    });
    if(data.layers[key].visible){
      map.addLayer(clusters[key]);
    }

    const div=document.createElement("div");
    div.className="layer-toggle";
    div.innerHTML=`
      <label>
        <input type="checkbox" ${data.layers[key].visible?"checked":""}>
        ${data.layers[key].label}
      </label>
    `;
    div.querySelector("input").onchange=e=>{
      if(e.target.checked) map.addLayer(clusters[key]);
      else map.removeLayer(clusters[key]);
    };
    toggles.appendChild(div);
  }

  // Marker referansları
  const markers = [];

  data.dealers.forEach(d=>{
    const color=data.layers[d.type].color;
    const icon=L.divIcon({
      html:`<svg width="28" height="28" viewBox="0 0 24 24" fill="${color}">
        <path d="M12 2C8.1 2 5 5.1 5 9c0 5.2 7 13 7 13s7-7.8 7-13c0-3.9-3.1-7-7-7z"/>
      </svg>`,
      className:"",
      iconSize:[28,28],
      iconAnchor:[14,28]
    });

    const marker=L.marker([d.lat,d.lng],{icon})
      .bindPopup(`
        <strong>${d.name}</strong><br>
        ${d.address}<br>
        <a target="_blank"
           href="https://www.google.com/maps/dir/?api=1&destination=${d.lat},${d.lng}">
           Yol tarifi al
        </a>
      `);

    clusters[d.type].addLayer(marker);
    markers.push({ marker, data:d });

    const div=document.createElement("div");
    div.className="dealer";
    div.innerHTML=`<strong>${d.name}</strong><br><small>${d.city}</small>`;
    div.onclick=()=>{
      map.setView([d.lat,d.lng],14);
      marker.openPopup();
    };
    dealerList.appendChild(div);
  });

  function applyCityFilter(){
    const city = citySelect.value;
    let count=0;

    markers.forEach(o=>{
      const visible = !city || o.data.city===city;
      if(visible){
        clusters[o.data.type].addLayer(o.marker);
        count++;
      } else {
        clusters[o.data.type].removeLayer(o.marker);
      }
    });

    if(city){
      counter.innerText = `${city}: ${count}`;
      const cityMarkers = markers.filter(o=>o.data.city===city);
      if(cityMarkers.length){
        const group = L.featureGroup(cityMarkers.map(o=>o.marker));
        map.fitBounds(group.getBounds().pad(0.3));
      }
    } else {
      counter.innerText = `Türkiye: ${count}`;
      map.setView([39,35],6);
    }
  }

  citySelect.onchange = applyCityFilter;
  applyCityFilter();
});
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<title>Foraflora Bayiler</title>
<meta name="robots" content="noindex,nofollow">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>

<style>
body { margin:0; font-family:Arial,sans-serif; }
#container { display:flex; height:100vh; }
#sidebar {
  width:320px; padding:12px;
  border-right:1px solid #eee;
  overflow-y:auto;
}
#map { flex:1; }
.counter {
  background:#f5f5f5;
  padding:8px;
  margin-bottom:10px;
  border-radius:6px;
  font-weight:bold;
}
.layer-toggle { margin-bottom:6px; }
.dealer {
  cursor:pointer;
  padding:6px 4px;
  border-bottom:1px solid #f0f0f0;
}
.dealer:hover { background:#f7f7f7; }
.dealer small { color:#666; }
</style>
</head>

<body>
<div id="container">
  <div id="sidebar">
    <h3>Bayiler</h3>
    <div id="counter" class="counter">TÃ¼rkiye: 0</div>
    <div id="layerToggles"></div>
    <div id="dealerList"></div>
  </div>
  <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
const map = L.map("map", { zoomSnap: 0.5 }).setView([39,35], 6);

// ðŸŒ¿ Premium gÃ¶rÃ¼nÃ¼mlÃ¼, soft harita
L.tileLayer(
  "https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",
  { attribution:"Â© OpenStreetMap Â© CARTO" }
).addTo(map);

fetch("dealers.json")
.then(r=>r.json())
.then(data=>{
  const layers = {};
  const clusters = {};
  const dealerList = document.getElementById("dealerList");
  const toggles = document.getElementById("layerToggles");
  const counter = document.getElementById("counter");

  // SayaÃ§ gÃ¼ncelle
  function updateCounter(){
    const bounds = map.getBounds();
    let count = 0;
    data.dealers.forEach(d=>{
      if(bounds.contains([d.lat,d.lng])) count++;
    });

    let cityCounts = {};
    data.dealers.forEach(d=>{
      if(bounds.contains([d.lat,d.lng])){
        cityCounts[d.city]=(cityCounts[d.city]||0)+1;
      }
    });

    if(map.getZoom()<7){
      counter.innerText = `TÃ¼rkiye: ${count}`;
    } else {
      const txt = Object.entries(cityCounts)
        .map(([c,n])=>`${c}: ${n}`)
        .join(" Â· ");
      counter.innerText = txt || "â€”";
    }
  }

  map.on("moveend zoomend", updateCounter);

  // Katmanlar
  for(const key in data.layers){
    clusters[key] = L.markerClusterGroup({
      spiderfyOnMaxZoom:true,
      showCoverageOnHover:false
    });
    layers[key] = clusters[key];

    if(data.layers[key].visible){
      map.addLayer(layers[key]);
    }

    const div=document.createElement("div");
    div.className="layer-toggle";
    div.innerHTML=`
      <label>
        <input type="checkbox" ${data.layers[key].visible?"checked":""}>
        ${data.layers[key].label}
      </label>
    `;
    div.querySelector("input").onchange=e=>{
      if(e.target.checked) map.addLayer(layers[key]);
      else map.removeLayer(layers[key]);
    };
    toggles.appendChild(div);
  }

  // Marker + Liste
  data.dealers.forEach(d=>{
    const color=data.layers[d.type].color;
    const icon=L.divIcon({
      html:`
      <svg width="28" height="28" viewBox="0 0 24 24" fill="${color}">
        <path d="M12 2C8.1 2 5 5.1 5 9c0 5.2 7 13 7 13s7-7.8 7-13c0-3.9-3.1-7-7-7z"/>
      </svg>`,
      className:"",
      iconSize:[28,28],
      iconAnchor:[14,28]
    });

    const marker=L.marker([d.lat,d.lng],{icon})
      .bindPopup(`
        <strong>${d.name}</strong><br>
        ${d.address}<br>
        <a target="_blank"
           href="https://www.google.com/maps/dir/?api=1&destination=${d.lat},${d.lng}">
           Yol tarifi al
        </a>
      `);

    clusters[d.type].addLayer(marker);

    const div=document.createElement("div");
    div.className="dealer";
    div.innerHTML=`<strong>${d.name}</strong><br><small>${d.city}</small>`;
    div.onclick=()=>{
      map.setView([d.lat,d.lng],14);
      marker.openPopup();
    };
    dealerList.appendChild(div);
  });

  updateCounter();
});
</script>
</body>
</html>
